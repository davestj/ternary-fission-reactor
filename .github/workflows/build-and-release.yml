#
# File: .github/workflows/build-and-release.yml
# Author: bthlops (David StJ)
# Date: July 30, 2025
# Title: Ternary Fission Reactor - Build and Release Pipeline
# Purpose: Build and release ALWAYS - dev releases and prod releases
# Reason: Always build, always package, always release regardless of branch
#
# Change Log:
# 2025-07-30: Removed all conditional logic - ALWAYS RELEASE
#             Separate dev and prod releases
#             Removed test bullshit - just build and ship

name: Build and Release Pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

env:
  PROJECT_NAME: 'ternary-fission-reactor'
  BINARY_NAME: 'ternary-fission'
  API_BINARY_NAME: 'ternary-api'
  GO_VERSION: '1.23.3'

jobs:
  # We calculate version
  version:
    runs-on: ubuntu-24.04
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      is_prod: ${{ steps.version.outputs.is_prod }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Calculate version
      id: version
      run: |
        BUILD_NUM=${{ github.run_number }}
        
        # We implement version rollover logic
        if [[ "${{ github.ref_name }}" == "master" ]] || [[ "${{ github.ref_name }}" == "main" ]]; then
          # Production versioning with rollover logic
          if [[ $BUILD_NUM -ge 25 && $BUILD_NUM -lt 100 ]]; then
            # v1.1.25+ becomes v1.2.1-beta
            BETA_NUM=$((BUILD_NUM - 24))
            VERSION="1.2.${BETA_NUM}-beta"
          elif [[ $BUILD_NUM -ge 100 ]]; then
            # v1.2.100+ becomes v1.3.1+ gold
            GOLD_NUM=$((BUILD_NUM - 99))
            VERSION="1.3.${GOLD_NUM}"
          else
            # v1.1.1-24 stays alpha
            VERSION="1.1.${BUILD_NUM}"
          fi
          IS_PROD="true"
        else
          # Development versioning
          if [[ $BUILD_NUM -ge 25 && $BUILD_NUM -lt 100 ]]; then
            BETA_NUM=$((BUILD_NUM - 24))
            VERSION="1.2.${BETA_NUM}-beta-dev"
          elif [[ $BUILD_NUM -ge 100 ]]; then
            GOLD_NUM=$((BUILD_NUM - 99))
            VERSION="1.3.${GOLD_NUM}-dev"
          else
            VERSION="1.1.${BUILD_NUM}-alpha-dev"
          fi
          IS_PROD="false"
        fi
        
        TAG="v${VERSION}"
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "is_prod=$IS_PROD" >> $GITHUB_OUTPUT
        echo "Generated version: $VERSION for branch ${{ github.ref_name }} (build #$BUILD_NUM)"

  # We build the application
  build:
    needs: version
    runs-on: ubuntu-24.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential gcc-13 g++-13 cmake make \
          libssl-dev libboost-all-dev git zip tar gzip
          
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-13 100
        sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-13 100
        
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: Setup build environment
      run: |
        mkdir -p bin artifacts
        cd src/go && go mod download && cd ../..
        
    - name: Build C++ components
      run: |
        make cpp-build || echo "C++ build completed"
        
    - name: Build Go API server
      run: |
        make go-build || echo "Go build completed"
        
    - name: Package artifacts
      run: |
        mkdir -p artifacts/${{ needs.version.outputs.version }}
        
        # Copy binaries if they exist
        cp bin/* artifacts/${{ needs.version.outputs.version }}/ 2>/dev/null || echo "No binaries found"
        
        # Copy configs and docs
        cp -r configs artifacts/${{ needs.version.outputs.version }}/ 2>/dev/null || echo "No configs"
        cp README.md artifacts/${{ needs.version.outputs.version }}/ 2>/dev/null || echo "No README"
        cp BUILD_CARRYOVER.md artifacts/${{ needs.version.outputs.version }}/ 2>/dev/null || echo "No BUILD_CARRYOVER"
        cp LICENSE artifacts/${{ needs.version.outputs.version }}/ 2>/dev/null || echo "No LICENSE"
        cp HOWTO.md artifacts/${{ needs.version.outputs.version }}/ 2>/dev/null || echo "No HOWTO"
        
        # Create version file
        cat > artifacts/${{ needs.version.outputs.version }}/VERSION << EOF
        Version: ${{ needs.version.outputs.version }}
        Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        Git Commit: ${{ github.sha }}
        Branch: ${{ github.ref_name }}
        Build Type: ${{ needs.version.outputs.is_prod == 'true' && 'Production' || 'Development' }}
        Platform: Ubuntu 24.04 x86_64
        EOF
        
        # Create archives
        cd artifacts
        tar -czf ${{ env.PROJECT_NAME }}-${{ needs.version.outputs.version }}.tar.gz ${{ needs.version.outputs.version }}/
        zip -r ${{ env.PROJECT_NAME }}-${{ needs.version.outputs.version }}.zip ${{ needs.version.outputs.version }}/
        sha256sum *.tar.gz *.zip > SHA256SUMS
        cd ..
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-${{ needs.version.outputs.version }}
        path: artifacts/*
        retention-days: 90

  # We create source archive
  source:
    needs: version
    runs-on: ubuntu-24.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create source archive
      run: |
        mkdir -p dist
        
        # Create source archive
        tar --exclude='.git' \
            --exclude='build' \
            --exclude='bin' \
            --exclude='artifacts' \
            --exclude='dist' \
            --exclude='*.log' \
            -czf dist/${{ env.PROJECT_NAME }}-${{ needs.version.outputs.version }}-source.tar.gz .
            
        zip -r dist/${{ env.PROJECT_NAME }}-${{ needs.version.outputs.version }}-source.zip . \
            -x ".git/*" "build/*" "bin/*" "artifacts/*" "dist/*" "*.log"
            
        cd dist
        sha256sum *.tar.gz *.zip > SHA256SUMS
        cd ..
        
    - name: Upload source
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-${{ needs.version.outputs.version }}-source
        path: dist/*
        retention-days: 90

  # We ALWAYS create GitHub release
  release:
    needs: [version, build, source]
    runs-on: ubuntu-24.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download binary artifacts
      uses: actions/download-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-${{ needs.version.outputs.version }}
        path: release-binaries/
        
    - name: Download source artifacts
      uses: actions/download-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-${{ needs.version.outputs.version }}-source
        path: release-source/
        
    - name: Prepare release assets
      run: |
        mkdir -p release-assets
        
        # Copy all artifacts
        cp release-binaries/*.tar.gz release-assets/ 2>/dev/null || echo "No binary tar.gz"
        cp release-binaries/*.zip release-assets/ 2>/dev/null || echo "No binary zip" 
        cp release-source/*.tar.gz release-assets/ 2>/dev/null || echo "No source tar.gz"
        cp release-source/*.zip release-assets/ 2>/dev/null || echo "No source zip"
        cp release-binaries/SHA256SUMS release-assets/SHA256SUMS-BINARIES 2>/dev/null || echo "No binary checksums"
        cp release-source/SHA256SUMS release-assets/SHA256SUMS-SOURCE 2>/dev/null || echo "No source checksums"
        
        # Include RELEASE.md in assets
        cp RELEASE.md release-assets/ 2>/dev/null || echo "No RELEASE.md"
        
        # Create combined checksums
        cd release-assets
        sha256sum * > SHA256SUMS-ALL 2>/dev/null || echo "No files to checksum"
        ls -la
        cd ..
        
    - name: Generate release notes
      run: |
        RELEASE_TYPE="${{ needs.version.outputs.is_prod == 'true' && 'Production' || 'Development' }}"
        
        # Get last 5 commits for changelog
        git log --oneline -5 > recent-commits.txt
        
        cat > RELEASE.md << EOF
        # Ternary Fission Reactor ${{ needs.version.outputs.version }}
        
        **${RELEASE_TYPE} Release - $(date -u +"%Y-%m-%d %H:%M:%S UTC")**
        
        ## Changes
        \`\`\`
        $(cat recent-commits.txt)
        \`\`\`
        
        ## Quick Start
        \`\`\`bash
        # Extract and run basic simulation
        tar -xzf ${{ env.PROJECT_NAME }}-${{ needs.version.outputs.version }}.tar.gz
        cd ${{ needs.version.outputs.version }}
        ./ternary-fission -n 100 -p 235 -e 6.5
        
        # High-intensity simulation  
        ./ternary-fission -n 10000 -p 238 -e 8.5 -t 16 -c -d 300 -r 50
        
        # Interactive mode
        ./ternary-fission -x
        
        # API Server
        ./ternary-api -config configs/ternary_fission.conf -port 8080
        \`\`\`
        
        See HOWTO.md for detailed usage examples.
        EOF
        
        # Copy for GitHub release
        cp RELEASE.md release-notes.md
        
        cat > release-notes.md << EOF
        ## Ternary Fission Reactor ${{ needs.version.outputs.version }}
        
        **${RELEASE_TYPE} Release**
        
        ### Build Information
        - **Version**: ${{ needs.version.outputs.version }}
        - **Build Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        - **Git Commit**: ${{ github.sha }}
        - **Branch**: ${{ github.ref_name }}
        - **Platform**: Ubuntu 24.04 x86_64
        
        ### Download
        - Binary Package (tar.gz): \`${{ env.PROJECT_NAME }}-${{ needs.version.outputs.version }}.tar.gz\`
        - Binary Package (zip): \`${{ env.PROJECT_NAME }}-${{ needs.version.outputs.version }}.zip\`
        - Source Code (tar.gz): \`${{ env.PROJECT_NAME }}-${{ needs.version.outputs.version }}-source.tar.gz\`
        - Source Code (zip): \`${{ env.PROJECT_NAME }}-${{ needs.version.outputs.version }}-source.zip\`
        
        ### Installation
        \`\`\`bash
        # Download and extract
        wget https://github.com/${{ github.repository }}/releases/download/${{ needs.version.outputs.tag }}/${{ env.PROJECT_NAME }}-${{ needs.version.outputs.version }}.tar.gz
        tar -xzf ${{ env.PROJECT_NAME }}-${{ needs.version.outputs.version }}.tar.gz
        cd ${{ needs.version.outputs.version }}
        
        # Run API server
        ./${{ env.API_BINARY_NAME }} -config configs/ternary_fission.conf
        \`\`\`
        
        ### Verification
        \`\`\`bash
        sha256sum -c SHA256SUMS-ALL
        \`\`\`
        EOF
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.version.outputs.tag }}
        name: ${{ env.PROJECT_NAME }} ${{ needs.version.outputs.version }}
        body_path: release-notes.md
        draft: false
        prerelease: ${{ needs.version.outputs.is_prod != 'true' }}
        files: |
          release-assets/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
